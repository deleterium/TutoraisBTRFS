# Entendendo subvolumes em BTRFS
Já usei o OpenSUSE Tumbleweed por um mês e gostei das possibilidades de snapshots. O programa snapper resolve de forma definitiva a organização para deletar snapshots antigos e garimpar informações sobre alterações, inclusive com um diff como opção para visualizar diferenças entre versões de arquivo.

Porém tentei entender a lógica dos subvolumes e me perdi diversas vezes. Nessa última semana me propuz a masterizar esse assunto e como exercício alterei uma instalação do linux Mint na máquina virtual de uma instalação padrão (apenas uma partição EFI e uma EXT4) para uma instalação com suporte a snapshots usando o snapper. Quebrei o sistema diversas vezes, consertei e aprendi bastante. Não vou fazer disso um tutorial dessa transformação, mas sim condensar informações que não são corriqueiras em tutoriais sobre o assunto mas que são de fundamental importância para saber como funcionam os subvolumes. Foram pontos que eu me bati para entender.
## 1) Volume BTRFS sem subvolumes
Mantra: O ID de uma partição BTRFS sem subvolumes é 5! O ID do volume é 5. Por que 5? Não sei, mas é cinco. É um número mágico quando se trata de btrfs, portanto lembre-se dessa lição. O nome desse “subvolume” é especial: (FS_TREE) e eu vou chamá-lo de Árvore.
## 2) O que acontece quando monto uma partição btrfs sem especificar ID ou nome de subvolume?
Simples, todo volume btrfs guarda uma informação de ID-padrão, ou Default-ID. Se nenhum subvolume foi criado, essa variável guarda o ID 5. Ao montar o volume btrfs, o sistema pega o valor do id-padrão e monta o subvolume com essa id. No caso de não haver subvolumes, é montada a árvore do sistema de arquivos (FS_TREE). (Resposta continua no ITEM 5)
## 3) O que acontece quando eu crio um subvolume?
Primeiro, lembre-se que você cria um subvolume num sistema de arquivos que foi montado. Portanto o subvolume criado vira um filho do subvolume em questão. Se é o primeiro subvolume que você criou, ele vai ser filho do ID 5! O ID desse primeiro subvolume é geralmente algo perto de 250, mas provavelmente será referenciado pelo nome que foi escolhido. Se você voltar na pasta onde montou o btrfs, verá que apareceu um diretório com o mesmo nome do subvolume. Não se engane, aquele não é um diretório comum, é um subvolume! Para lembrar esse fato, duas abordagens são mais costumeiras:
1) Dar nomes aos subvolumes que comecem com @, todos eles filhos da Árvore (o id 5). Assim terá na Árvore os subvolumes @rootfs, @home, @snapshots, @var_log, etc…
2) Criar um subvolume de nome @, e criar todos os demais subvolumes dentro desse subvolume sem @ no nome. Para isso cria-se o subvolume @, depois cria-se novos subvolumes nele. Assim a referência desses subvolumes será @/home, @/.snapshots, @/usr/local . Nesse caso o subvolume pai do subvolume @/home não será o 5, mas o ID do @.

## 4) O que acontece quando monto uma partição btrfs especificando o nome de subvolume ou id?
Simples, no ponto de montagem especificado será montado o subvolume também especificado. Se não houver subvolume com esse ID ou nome, será retornado erro.
## 5) O que acontece quando monto uma partição btrfs sem especificar ID ou nome de subvolume?
O sistema irá montar o subvolume especificado no ID-Padrão. Agora que já há diversos subvolumes na partição o valor do id-padrão é importante. Você provavelmente vai querer mudar o ID-Padrão para o subvolume que escolheu ser o raiz do seu sistema operacional. Costumeiramente é o subvol @rootfs ou então o @. Assim quando o kernel montar o seu sistema de arquivos, já montará a raiz do sistema. Também não precisará alterar o seu /etc/fstab, deixando o ponto de montagem do / sem especificar subvolumes. Em sistemas que terão snapshots, também costuma-se deixar o ID-Padrão para o subvolume da atual versão dos arquivos.
## 6) Mas o GRUB? Como especificar o subvolume durante a inicalização?
O GRUB só vê a Árvore, ele só “monta” o ID 5. Então refira-se aos arquivos como se estivesse montando o **subvolid=5**. Para chamar o kernel, o comando ficará `linuxefi (hd0,gpt2)/@rootfs/boot/vmlinuz options` ou então `linuxefi /@rootfs/boot/vmlinuz options` caso já tenha especificado anteriormente a variável “root”.
* Dica: É costume criar um ponto de montagem /btrfs/ para montar a Árvore (**subvolid=5**). Isso facilita a visualização de subvolumes bem como operações de movimentação (renomear) dos subvolumes.
